<!DOCTYPE html>
<html>
<head>
  <title>CSV Modifier</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h3>Upload CSV of trading212 transactions to modify file for use on gryphonr's tax calculation tool https://gryphonr.github.io/taxing212/ </h3>
  <input type="file" id="csvFile" accept=".csv" />
  <button id="downloadBtn" disabled>Download Modified CSV</button>

  <script>
    let modifiedCsv = "";
    let originalFileName = "";

    document.getElementById("csvFile").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      originalFileName = file.name;

      Papa.parse(file, {
        complete: function (results) {
          const rows = results.data;

          const modified = rows.map(row => {
            if (row.length >= 14) {
              // Swap M (index 12) and N (index 13)
              [row[12], row[13]] = [row[13], row[12]];
            }
            if (row.length >= 7) {
              // Remove G (index 6) first, then F (index 5)
              row.splice(6, 1);
              row.splice(5, 1);
            }
            return row;
          });

          modifiedCsv = Papa.unparse(modified);
          document.getElementById("downloadBtn").disabled = false;
        }
      });
    });

    document.getElementById("downloadBtn").addEventListener("click", function () {
      // Add UTF-8 BOM for Excel compatibility
      const bom = "\uFEFF";
      const blob = new Blob([bom + modifiedCsv], { type: "text/csv;charset=utf-8;" });

      // Create new file name with "-modified" before the extension
      const dotIndex = originalFileName.lastIndexOf(".");
      let newFileName;
      if (dotIndex !== -1) {
        newFileName = originalFileName.slice(0, dotIndex) + "-modified" + originalFileName.slice(dotIndex);
      } else {
        newFileName = originalFileName + "-modified.csv";
      }

      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = newFileName;
      link.click();
    });
  </script>
</body>
</html>

